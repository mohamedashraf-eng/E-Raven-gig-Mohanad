<!-- cms/templates/cms/user_profile.html -->

{% extends "base.html" %}
{% load static %}
{% block title %}My Profile - ERaven Gigs{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">My Profile</h1>

    <!-- Timeline Calendar Section (Moved to Top) -->
    <div class="card mb-4">
        <div class="card-header">
            <h3>Timeline Calendar</h3>
        </div>
        <div class="card-body">
            <div id="calendar"></div>
        </div>
    </div>

    <!-- Dashboard Summary -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-info mb-3">
                <div class="card-body">
                    <h5 class="card-title">Quizzes Completed</h5>
                    <p class="card-text fs-3">{{ quiz_count }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success mb-3">
                <div class="card-body">
                    <h5 class="card-title">Assignments Submitted</h5>
                    <p class="card-text fs-3">{{ assignment_count }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning mb-3">
                <div class="card-body">
                    <h5 class="card-title">Challenges Participated</h5>
                    <p class="card-text fs-3">{{ challenge_count }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-secondary mb-3">
                <div class="card-body">
                    <h5 class="card-title">Workshops Attended</h5>
                    <p class="card-text fs-3">{{ workshop_count }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- User Information -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h3>{{ user.username }}'s Profile</h3>
            <!-- Edit Profile Button -->
            <a href="{% url 'edit_user_profile' %}" class="btn btn-primary btn-sm">
                <i class="fas fa-edit me-1"></i> Edit Profile
            </a>
        </div>
        <div class="card-body">
            <p><strong>Username:</strong> {{ user.username }}</p>
            <p><strong>Email:</strong> {{ user.email }}</p>
            <p><strong>Role:</strong> 
                {% if user.role %}
                    {{ user.role.name }}
                {% else %}
                    No Role Assigned
                {% endif %}
            </p>
            <p><strong>Total Points:</strong> {{ user.total_points }}</p>
            <p><strong>Level:</strong> {{ user.level }}</p>
        </div>
    </div>

    <!-- Enrolled Courses -->
    <div class="card mb-4">
        <div class="card-header">
            <h3>Enrolled Courses</h3>
        </div>
        <div class="card-body">
            {% if enrollments %}
                <ul class="list-group">
                    {% for enrollment in enrollments %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <a href="{% url 'cms:course_detail' enrollment.course.slug %}">{{ enrollment.course.title }}</a>
                            <span class="badge bg-primary rounded-pill">Enrolled on {{ enrollment.enrolled_at|date:"M d, Y" }}</span>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>You are not enrolled in any courses yet.</p>
            {% endif %}
        </div>
    </div>

    <!-- Progress -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h3>Course Progress</h3>
            <a href="{% url 'cms:user_progress' %}" class="btn btn-primary btn-sm">
                View Detailed Progress
            </a>
        </div>
        <div class="card-body">
            {% if progresses %}
                {% for progress in progresses %}
                    <div class="mb-3">
                        <h5>{{ progress.course.title }}</h5>
                        <div class="progress mb-2">
                            <div class="progress-bar" role="progressbar" style="width: {{ progress.progress_percentage }}%;" aria-valuenow="{{ progress.progress_percentage }}" aria-valuemin="0" aria-valuemax="100">
                                {{ progress.progress_percentage }}%
                            </div>
                        </div>
                        <p>Status: 
                            {% if progress.completed %}
                                <span class="badge bg-success">Completed</span>
                            {% else %}
                                <span class="badge bg-warning text-dark">In Progress</span>
                            {% endif %}
                        </p>
                    </div>
                {% endfor %}
            {% else %}
                <p>No progress available.</p>
            {% endif %}
        </div>
    </div>

    <!-- Points and Transactions -->
    <div class="card mb-4">
        <div class="card-header">
            <h3>Points Overview</h3>
        </div>
        <div class="card-body">
            {% if ranking %}
                <p><strong>Current Points:</strong> {{ user.total_points }}</p>
                <p><strong>Rank:</strong> {{ ranking.rank }}</p>
            {% else %}
                <p>You do not have a ranking yet.</p>
            {% endif %}

            <h4 class="mt-4">Point Transactions</h4>
            {% if point_transactions %}
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Points</th>
                            <th>Description</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for transaction in point_transactions %}
                            <tr>
                                <td>{{ transaction.get_transaction_type_display }}</td>
                                <td>
                                    {% if transaction.transaction_type == 'earn' %}
                                        <span class="text-success">+{{ transaction.points }}</span>
                                    {% else %}
                                        <span class="text-danger">-{{ transaction.points }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ transaction.description }}</td>
                                <td>{{ transaction.timestamp|date:"M d, Y H:i" }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>No point transactions found.</p>
            {% endif %}
        </div>
    </div>

    <!-- Ranking -->
    <div class="card mb-4">
        <div class="card-header">
            <h3>Global Ranking</h3>
        </div>
        <div class="card-body">
            {% if ranking %}
                <h5>Your Rank: {{ ranking.rank }}</h5>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>User</th>
                            <th>Points</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for rank in rankings %}
                            <tr {% if rank.user == user %}class="table-primary"{% endif %}>
                                <td>{{ rank.rank }}</td>
                                <td>{{ rank.user.username }}</td>
                                <td>{{ rank.points }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>Your ranking information is not available.</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Include FullCalendar CSS & JS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>

<!-- Optional: Include Bootstrap JS for tooltips (if not already included) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Initialize FullCalendar -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',  // Options: 'dayGridMonth', 'timeGridWeek', 'timeGridDay'
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            events: [
                {% for event in timeline_events %}
                {
                    title: "{{ event.get_event_type_display }}: {{ event.content_object.title }}",
                    start: "{{ event.event_date|date:"Y-m-d\TH:i:s" }}",  // ISO format required by FullCalendar
                    color: "{% if event.event_type == 'assignment' %}#28a745{% elif event.event_type == 'quiz' %}#007bff{% elif event.event_type == 'workshop' %}#ffc107{% else %}#6c757d{% endif %}",  // Green, Blue, Yellow, Grey
                    url: "{% if event.event_type == 'workshop' and event.content_object.meeting_link %}{{ event.content_object.meeting_link }}{% else %}#{% endif %}"
                },
                {% endfor %}
            ],
            eventClick: function (info) {
                if (info.event.url && info.event.url !== '#') {
                    window.open(info.event.url, "_blank");
                    info.jsEvent.preventDefault();  // Prevent browser from navigating to the link
                }
            },
            eventDidMount: function(info) {
                // Optional: Add tooltips or additional event details
                if (info.event.extendedProps.description) {
                    var tooltip = new bootstrap.Tooltip(info.el, {
                        title: info.event.extendedProps.description,
                        placement: 'top',
                        trigger: 'hover',
                        container: 'body'
                    });
                }
            }
        });

        calendar.render();
    });
</script>

<!-- Custom CSS for Calendar -->
<style>
    /* FullCalendar container adjustments */
    #calendar {
        max-width: 100%;
        margin: 0 auto;
    }

    /* Optional: Adjust event titles or other styles */
    .fc-event {
        cursor: pointer;
    }
</style>
{% endblock %}
