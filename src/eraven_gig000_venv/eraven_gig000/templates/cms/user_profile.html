<!-- cms/templates/cms/user_profile.html -->

{% extends "base.html" %}
{% load form_filters %}
{% load static %}
{% block title %}My Profile - ERaven Gigs{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4 text-center text-primary">My Profile</h1>

    <!-- Navbar with Tabs -->
    <ul class="nav nav-tabs mb-4" id="profileTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab" aria-controls="dashboard" aria-selected="true">
                <i class="fas fa-tachometer-alt me-1"></i> Dashboard
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="personal-data-tab" data-bs-toggle="tab" data-bs-target="#personal-data" type="button" role="tab" aria-controls="personal-data" aria-selected="false">
                <i class="fas fa-user me-1"></i> Personal Data
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="security-tab" data-bs-toggle="tab" data-bs-target="#security" type="button" role="tab" aria-controls="security" aria-selected="false">
                <i class="fas fa-shield-alt me-1"></i> Security
            </button>
        </li>
    </ul>

    <div class="tab-content" id="profileTabContent">
        <!-- Dashboard Tab -->
        <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
            <!-- Statistics Section -->
            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="card text-white statistic-card" style="background-color: #84D1DA;">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="card-title">Quizzes Completed</h5>
                                    <p class="card-text fs-3">{{ quiz_count }}</p>
                                </div>
                                <i class="fas fa-question-circle fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card text-white statistic-card" style="background-color: #5CC4B1;">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="card-title">Assignments Submitted</h5>
                                    <p class="card-text fs-3">{{ assignment_count }}</p>
                                </div>
                                <i class="fas fa-file-alt fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card text-white statistic-card" style="background-color: #0BA2B2;">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="card-title">Challenges Participated</h5>
                                    <p class="card-text fs-3">{{ challenge_count }}</p>
                                </div>
                                <i class="fas fa-trophy fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card text-white statistic-card" style="background-color: #77D770;">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="card-title">Workshops Attended</h5>
                                    <p class="card-text fs-3">{{ workshop_count }}</p>
                                </div>
                                <i class="fas fa-chalkboard-teacher fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Additional Statistics -->
            <div class="row mb-4">
                <div class="col-md-4 mb-3">
                    <div class="card text-white statistic-card" style="background-color: #84D1DA;">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="card-title">Total Points Earned</h5>
                                    <p class="card-text fs-3">{{ user.total_points }}</p>
                                </div>
                                <i class="fas fa-coins fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card text-white statistic-card" style="background-color: #5CC4B1;">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="card-title">Current Rank</h5>
                                    <p class="card-text fs-3">{{ ranking.rank }}</p>
                                </div>
                                <i class="fas fa-ranking-star fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Timeline Calendar Section -->
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">Timeline Calendar</h3>
                </div>
                <div class="card-body">
                    <div id="calendar"></div>
                </div>
            </div>

<!-- Accessible Courses -->
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-success text-white">
        <h3 class="mb-0">My Courses</h3>
    </div>
    <div class="card-body">
        {% if courses %}
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Course Title</th>
                            <th>Enrollment/Bundle Date</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for course in courses %}
                            <tr>
                                <td>
                                    <a href="{% url 'cms:course_detail' course.slug %}" class="text-decoration-none">
                                        {{ course.title }}
                                    </a>
                                </td>
                                <td>
                                    {% with enrollments|dict_key:course.id as enrollment %}
                                        {% if enrollment %}
                                            {{ enrollment.enrolled_at|date:"M d, Y" }}
                                        {% else %}
                                            <span class="text-muted">Via Bundle</span>
                                        {% endif %}
                                    {% endwith %}
                                </td>
                                <td>
                                    <span class="badge bg-success">Active</span>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="text-muted">You do not have access to any courses yet.</p>
        {% endif %}
    </div>
</div>

            <!-- Progress -->
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">Course Progress</h3>
                    <a href="{% url 'cms:user_progress' %}" class="btn btn-light btn-sm">
                        <i class="fas fa-chart-line me-1"></i> View Detailed Progress
                    </a>
                </div>
                <div class="card-body">
                    {% if progresses %}
                        <div class="accordion" id="progressAccordion">
                            {% for progress in progresses %}
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                                        <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ forloop.counter }}" aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}" aria-controls="collapse{{ forloop.counter }}">
                                            {{ progress.course.title }}
                                        </button>
                                    </h2>
                                    <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" aria-labelledby="heading{{ forloop.counter }}" data-bs-parent="#progressAccordion">
                                        <div class="accordion-body">
                                            <div class="progress mb-2" style="height: 25px;">
                                                <div class="progress-bar" role="progressbar" style="width: {{ progress.progress_percentage }}%; background-color: #0BA2B2;" aria-valuenow="{{ progress.progress_percentage }}" aria-valuemin="0" aria-valuemax="100">
                                                    {{ progress.progress_percentage }}%
                                                </div>
                                            </div>
                                            <p>Status: 
                                                {% if progress.completed %}
                                                    <span class="badge bg-success">Completed</span>
                                                {% else %}
                                                    <span class="badge bg-warning text-dark">In Progress</span>
                                                {% endif %}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">No progress available.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Points and Transactions -->
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <h3 class="mb-0">Points Overview</h3>
                </div>
                <div class="card-body">
                    {% if ranking %}
                        <p><strong>Current Points:</strong> {{ user.total_points }}</p>
                        <p><strong>Rank:</strong> {{ ranking.rank }}</p>
                    {% else %}
                        <p class="text-muted">You do not have a ranking yet.</p>
                    {% endif %}

                    <h4 class="mt-4">Point Transactions</h4>
                    {% if point_transactions %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Type</th>
                                        <th>Points</th>
                                        <th>Description</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for transaction in point_transactions %}
                                        <tr>
                                            <td>{{ transaction.get_transaction_type_display }}</td>
                                            <td>
                                                {% if transaction.transaction_type == 'earn' %}
                                                    <span class="text-success">+{{ transaction.points }}</span>
                                                {% else %}
                                                    <span class="text-danger">-{{ transaction.points }}</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ transaction.description }}</td>
                                            <td>{{ transaction.timestamp|date:"M d, Y H:i" }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted">No point transactions found.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Ranking -->
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-dark text-white">
                    <h3 class="mb-0">Global Ranking</h3>
                </div>
                <div class="card-body">
                    {% if ranking %}
                        <h5>Your Rank: {{ ranking.rank }}</h5>
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Rank</th>
                                        <th>User</th>
                                        <th>Points</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for rank in rankings %}
                                        <tr {% if rank.user == user %}class="table-primary"{% endif %}>
                                            <td>{{ rank.rank }}</td>
                                            <td>{{ rank.user.username }}</td>
                                            <td>{{ rank.points }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted">Your ranking information is not available.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Personal Data Tab -->
        <div class="tab-pane fade" id="personal-data" role="tabpanel" aria-labelledby="personal-data-tab">
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">{{ user.username }}'s Personal Data</h3>
                    <a href="{% url 'edit_user_profile' %}" class="btn btn-light btn-sm">
                        <i class="fas fa-edit me-1"></i> Edit Profile
                    </a>
                </div>
                <div class="card-body">
                    <form>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="firstName" class="form-label"><strong>First Name</strong></label>
                                <input type="text" class="form-control" id="firstName" value="{{ user.first_name }}" readonly>
                            </div>
                            <div class="col-md-6">
                                <label for="lastName" class="form-label"><strong>Last Name</strong></label>
                                <input type="text" class="form-control" id="lastName" value="{{ user.last_name }}" readonly>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label"><strong>Email</strong></label>
                            <input type="email" class="form-control" id="email" value="{{ user.email }}" readonly>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="level" class="form-label"><strong>Level</strong></label>
                                <input type="text" class="form-control" id="level" value="{{ user.level }}" readonly>
                            </div>
                            <div class="col-md-4">
                                <label for="totalPoints" class="form-label"><strong>Total Points Earned</strong></label>
                                <input type="text" class="form-control" id="totalPoints" value="{{ user.total_points }}" readonly>
                            </div>
                            <div class="col-md-4">
                                <label for="currentPoints" class="form-label"><strong>Current Points</strong></label>
                                <input type="text" class="form-control" id="currentPoints" value="{{ user.current_points }}" readonly>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="role" class="form-label"><strong>Role</strong></label>
                            <input type="text" class="form-control" id="role" value="{% if user.role %}{{ user.role.name }}{% else %}No Role Assigned{% endif %}" readonly>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Security Tab -->
        <div class="tab-pane fade" id="security" role="tabpanel" aria-labelledby="security-tab">
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <h3 class="mb-0">Security Settings</h3>
                </div>
                <div class="card-body">
                    <p class="text-muted">Security features coming soon. Stay tuned!</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include FullCalendar CSS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />

<!-- Include Font Awesome for Icons -->
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

<!-- Include Bootstrap JS and dependencies -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Include FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>

<!-- Link to External CSS -->
<link href="{% static 'css/user_profile.css' %}" rel="stylesheet" />

<!-- Initialize FullCalendar -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            events: [
                {% for event in timeline_events %}
                {
                    title: "{{ event.get_event_type_display }}: {{ event.content_object.title }}",
                    start: "{{ event.event_date|date:"Y-m-d\TH:i:s" }}",
                    color: "{% if event.event_type == 'assignment' %}#77D770{% elif event.event_type == 'quiz' %}#84D1DA{% elif event.event_type == 'workshop' %}#C3FC47{% else %}#5CC4B1{% endif %}",
                    url: "{% if event.event_type == 'workshop' and event.content_object.meeting_link %}{{ event.content_object.meeting_link }}{% else %}#{% endif %}"
                },
                {% endfor %}
            ],
            eventClick: function (info) {
                if (info.event.url && info.event.url !== '#') {
                    window.open(info.event.url, "_blank");
                    info.jsEvent.preventDefault();
                }
            },
            eventDidMount: function(info) {
                if (info.event.extendedProps.description) {
                    var tooltip = new bootstrap.Tooltip(info.el, {
                        title: info.event.extendedProps.description,
                        placement: 'top',
                        trigger: 'hover',
                        container: 'body'
                    });
                }
            }
        });

        calendar.render();
    });
</script>
{% endblock %}
