<!-- cms/templates/cms/course_detail.html -->

{% extends "base.html" %}
{% load static %}
{% load custom_filters %}  {# Ensure this includes 'get_detail_url' #}

{% block title %}{{ course.title }} - ERaven Gigs{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Course Header -->
    <div class="row mb-4 align-items-center">
        <div class="col-md-8">
            <h1 class="text-primary">{{ course.title }}</h1>
            {% if course.instructor %}
                <p class="text-muted">Instructor: {{ course.instructor.get_full_name }}</p>
            {% endif %}
        </div>
        <div class="col-md-4 text-md-end">
            {% if user.is_authenticated %}
                {% if user|is_enrolled:course %}
                    <a href="{% url 'enrolled_courses' %}" class="btn btn-success btn-lg">
                        <i class="fas fa-check-circle me-2"></i> Enrolled
                    </a>
                {% else %}
                    <a href="{% url 'cms:enroll_course' course.slug %}" class="btn btn-primary btn-lg">
                        <i class="fas fa-user-plus me-2"></i> Enroll Now
                    </a>
                {% endif %}
            {% else %}
                <a href="{% url 'api:sign-in' %}?next={% url 'cms:enroll_course' course.slug %}" class="btn btn-primary btn-lg">
                    <i class="fas fa-sign-in-alt me-2"></i> Login to Enroll
                </a>
            {% endif %}
        </div>
    </div>

    <!-- Course Image -->
    {% if course.picture %}
        <div class="row mb-4">
            <div class="col-12">
                <img src="{{ course.picture.url }}" alt="{{ course.title }} Image" class="img-fluid rounded shadow-sm course-image">
            </div>
        </div>
    {% endif %}

    <!-- Separated Course Details -->
    <div class="row mb-5">
        {% if course.description %}
            <div class="col-md-4">
                <div class="mb-3">
                    <h4 class="section-title">Description</h4>
                    <p>{{ course.description }}</p>
                </div>
            </div>
        {% endif %}
        {% if course.syllabus %}
            <div class="col-md-4">
                <div class="mb-3">
                    <h4 class="section-title">Syllabus</h4>
                    <p>{{ course.syllabus }}</p>
                </div>
            </div>
        {% endif %}
        {% if course.prerequisites %}
            <div class="col-md-4">
                <div class="mb-3">
                    <h4 class="section-title">Prerequisites</h4>
                    <p>{{ course.prerequisites }}</p>
                </div>
            </div>
        {% endif %}
    </div>
        
    <!-- Tab Navigation -->
    <ul class="nav nav-tabs mb-4" id="courseTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab" aria-controls="overview" aria-selected="true">
                <i class="fas fa-info-circle me-1"></i> Overview
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="assignments-tab" data-bs-toggle="tab" data-bs-target="#assignments" type="button" role="tab" aria-controls="assignments" aria-selected="false">
                <i class="fas fa-file-alt me-1"></i> Assignments
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="challenges-tab" data-bs-toggle="tab" data-bs-target="#challenges" type="button" role="tab" aria-controls="challenges" aria-selected="false">
                <i class="fas fa-trophy me-1"></i> Challenges
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="articles-tab" data-bs-toggle="tab" data-bs-target="#articles" type="button" role="tab" aria-controls="articles" aria-selected="false">
                <i class="fas fa-newspaper me-1"></i> Articles
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="videos-tab" data-bs-toggle="tab" data-bs-target="#videos" type="button" role="tab" aria-controls="videos" aria-selected="false">
                <i class="fas fa-video me-1"></i> Videos
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="sessions-tab" data-bs-toggle="tab" data-bs-target="#sessions" type="button" role="tab" aria-controls="sessions" aria-selected="false">
                <i class="fas fa-calendar-alt me-1"></i> Sessions
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="documentation-tab" data-bs-toggle="tab" data-bs-target="#documentation" type="button" role="tab" aria-controls="documentation" aria-selected="false">
                <i class="fas fa-book me-1"></i> Documentation
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="related-courses-tab" data-bs-toggle="tab" data-bs-target="#related-courses" type="button" role="tab" aria-controls="related-courses" aria-selected="false">
                <i class="fas fa-link me-1"></i> Related Courses
            </button>
        </li>
    </ul>

    <div class="tab-content" id="courseTabContent">
        <!-- Overview Tab -->
        <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
            <!-- Unified Timeline -->
            {% if combined_timeline %}
                <hr>
                <h4 class="section-title">Timeline</h4>
                <div class="timeline">
                    {% for item in combined_timeline %}
                        <div class="timeline-item animate__animated animate__fadeInUp">
                            <div class="timeline-left">
                                {% if item|is_instance:"Assignment" %}
                                    <div class="timeline-dot bg-warning"></div>
                                    <div class="timeline-time">
                                        {{ item.due_date|date:"F j, Y" }}
                                    </div>
                                {% elif item|is_instance:"Challenge" %}
                                    <div class="timeline-dot bg-danger"></div>
                                    <div class="timeline-time">
                                        {{ item.date|date:"F j, Y" }}
                                    </div>
                                {% elif item|is_instance:"Quiz" %}
                                    <div class="timeline-dot bg-success"></div>
                                    <div class="timeline-time">
                                        {{ item.date|date:"F j, Y" }}
                                    </div>
                                {% elif item|is_instance:"Article" %}
                                    <div class="timeline-dot bg-primary"></div>
                                    <div class="timeline-time">
                                        {{ item.created_at|date:"F j, Y" }}
                                    </div>
                                {% elif item|is_instance:"Video" %}
                                    <div class="timeline-dot bg-info"></div>
                                    <div class="timeline-time">
                                        {{ item.created_at|date:"F j, Y" }}
                                    </div>
                                {% elif item|is_instance:"Session" %}
                                    <div class="timeline-dot bg-purple"></div>
                                    <div class="timeline-time">
                                        {{ item.date_time|date:"F j, Y, g:i a" }}
                                    </div>
                                {% elif item|is_instance:"Documentation" %}
                                    <div class="timeline-dot bg-secondary"></div>
                                    <div class="timeline-time">
                                        {{ item.created_at|date:"F j, Y" }}
                                    </div>
                                {% else %}
                                    <div class="timeline-dot bg-light"></div>
                                    <div class="timeline-time">
                                        <!-- Optional: Handle other types or leave blank -->
                                    </div>
                                {% endif %}
                            </div>
                            <div class="timeline-content">
                                <h5>{{ item.title }}</h5>
                                <p class="text-muted">
                                    {% if item.due_date %}
                                        Due Date: {{ item.due_date|date:"F j, Y" }}
                                    {% elif item.date %}
                                        Date: {{ item.date|date:"F j, Y" }}
                                    {% elif item.created_at %}
                                        Published on: {{ item.created_at|date:"F j, Y" }}
                                    {% elif item.date_time %}
                                        Date & Time: {{ item.date_time|date:"F j, Y, g:i a" }}
                                    {% endif %}
                                </p>
                                {% if item.meeting_link %}
                                    <p><strong>Meeting Link:</strong> <a href="{{ item.meeting_link }}" target="_blank" class="meeting-link">Join</a></p>
                                {% endif %}
                                {% if not item|is_instance:"Session" and not item|is_instance:"Workshop" %}
                                    <a href="{{ item.get_detail_url }}" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-eye me-1"></i> View Details
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-muted">No timeline events available for this course.</p>
            {% endif %}
        </div>

        <!-- Assignments Tab -->
        <div class="tab-pane fade" id="assignments" role="tabpanel" aria-labelledby="assignments-tab">
            {% if assignments %}
                <div class="timeline">
                    {% for assignment in assignments|dictsortreversed:"due_date" %}
                        <div class="timeline-item animate__animated animate__fadeInUp">
                            <div class="timeline-left">
                                <div class="timeline-dot bg-warning"></div>
                                <div class="timeline-time">
                                    {{ assignment.due_date|date:"F j, Y" }}
                                </div>
                            </div>
                            <div class="timeline-content">
                                <h5>{{ assignment.title }}</h5>
                                <p class="text-muted">Due Date: {{ assignment.due_date|date:"F j, Y" }}</p>
                                <a href="{{ assignment.get_detail_url }}" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-eye me-1"></i> View Details
                                </a>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-muted">No assignments available for this course.</p>
            {% endif %}
        </div>

        <!-- Challenges Tab -->
        <div class="tab-pane fade" id="challenges" role="tabpanel" aria-labelledby="challenges-tab">
            {% if challenges %}
                <div class="timeline">
                    {% for challenge in challenges|dictsortreversed:"date" %}
                        <div class="timeline-item animate__animated animate__fadeInUp">
                            <div class="timeline-left">
                                <div class="timeline-dot bg-danger"></div>
                                <div class="timeline-time">
                                    {{ challenge.date|date:"F j, Y" }}
                                </div>
                            </div>
                            <div class="timeline-content">
                                <h5>{{ challenge.title }}</h5>
                                <p class="text-muted">Date: {{ challenge.date|date:"F j, Y" }}</p>
                                <a href="{{ challenge.get_detail_url }}" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-eye me-1"></i> View Details
                                </a>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-muted">No challenges available for this course.</p>
            {% endif %}
        </div>

        <!-- Articles Tab -->
        <div class="tab-pane fade" id="articles" role="tabpanel" aria-labelledby="articles-tab">
            {% if articles %}
                <div class="timeline">
                    {% for article in articles|dictsortreversed:"created_at" %}
                        <div class="timeline-item animate__animated animate__fadeInUp">
                            <div class="timeline-left">
                                <div class="timeline-dot bg-primary"></div>
                                <div class="timeline-time">
                                    {{ article.created_at|date:"F j, Y" }}
                                </div>
                            </div>
                            <div class="timeline-content">
                                <h5>{{ article.title }}</h5>
                                <p class="text-muted">Published on: {{ article.created_at|date:"F j, Y" }}</p>
                                <a href="{{ article.get_detail_url }}" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-eye me-1"></i> View Details
                                </a>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-muted">No articles available for this course.</p>
            {% endif %}
        </div>

        <!-- Videos Tab -->
        <div class="tab-pane fade" id="videos" role="tabpanel" aria-labelledby="videos-tab">
            {% if videos %}
                <div class="timeline">
                    {% for video in videos|dictsortreversed:"created_at" %}
                        <div class="timeline-item animate__animated animate__fadeInUp">
                            <div class="timeline-left">
                                <div class="timeline-dot bg-info"></div>
                                <div class="timeline-time">
                                    {{ video.created_at|date:"F j, Y" }}
                                </div>
                            </div>
                            <div class="timeline-content">
                                <h5>{{ video.title }}</h5>
                                <p class="text-muted">{{ video.created_at|date:"F j, Y" }}</p>
                                <a href="{{ video.get_detail_url }}" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-eye me-1"></i> View Details
                                </a>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-muted">No videos available for this course.</p>
            {% endif %}
        </div>

        <!-- Sessions Tab -->
        <div class="tab-pane fade" id="sessions" role="tabpanel" aria-labelledby="sessions-tab">
            {% if sessions %}
                <div class="timeline">
                    {% for session in sessions|dictsortreversed:"date_time" %}
                        <div class="timeline-item animate__animated animate__fadeInUp">
                            <div class="timeline-left">
                                <div class="timeline-dot bg-purple"></div>
                                <div class="timeline-time">
                                    {{ session.date_time|date:"F j, Y, g:i a" }}
                                </div>
                            </div>
                            <div class="timeline-content">
                                <h5>{{ session.title }}</h5>
                                {% if session.date_time %}
                                    <p class="text-muted">Date & Time: {{ session.date_time|date:"F j, Y, g:i a" }}</p>
                                {% endif %}
                                {% if session.meeting_link %}
                                    <p><strong>Meeting Link:</strong> <a href="{{ session.meeting_link }}" target="_blank" class="meeting-link">Join Session</a></p>
                                {% endif %}
                                <!-- "View Details" button removed for Sessions -->
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-muted">No sessions available for this course.</p>
            {% endif %}
        </div>

        <!-- Documentation Tab -->
        <div class="tab-pane fade" id="documentation" role="tabpanel" aria-labelledby="documentation-tab">
            {% if documentations %}
                <div class="timeline">
                    {% for doc in documentations|dictsortreversed:"created_at" %}
                        <div class="timeline-item animate__animated animate__fadeInUp">
                            <div class="timeline-left">
                                <div class="timeline-dot bg-secondary"></div>
                                <div class="timeline-time">
                                    {{ doc.created_at|date:"F j, Y" }}
                                </div>
                            </div>
                            <div class="timeline-content">
                                <h5>{{ doc.title }}</h5>
                                <p class="text-muted">Published on: {{ doc.created_at|date:"F j, Y" }}</p>
                                <a href="{{ doc.get_detail_url }}" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-eye me-1"></i> View Details
                                </a>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-muted">No documentation available for this course.</p>
            {% endif %}
        </div>

        <!-- Related Courses Tab -->
        <div class="tab-pane fade" id="related-courses" role="tabpanel" aria-labelledby="related-courses-tab">
            {% if related_courses %}
                <hr>
                <h3 class="mb-4">Related Courses</h3>
                <div class="row row-cols-1 row-cols-md-3 g-4">
                    {% for related in related_courses %}
                        <div class="col">
                            <div class="card h-100 shadow-sm border-0">
                                {% if related.picture %}
                                    <img src="{{ related.picture.url }}" class="card-img-top related-course-image" alt="{{ related.title }} Image">
                                {% else %}
                                    <img src="{% static 'images/default_course.png' %}" class="card-img-top related-course-image" alt="Default Course Image">
                                {% endif %}
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title">{{ related.title }}</h5>
                                    <p class="card-text">{{ related.description|truncatewords:15 }}</p>
                                    <a href="{{ related.get_detail_url }}" class="btn btn-outline-primary mt-auto">
                                        <i class="fas fa-eye me-1"></i> View Details
                                    </a>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-muted">No related courses found.</p>
            {% endif %}
        </div>
    </div>

    <!-- Challenges Related to Course Section -->
    {% if challenges_related %}
        <hr>
        <h3 class="mb-4 text-center text-dark">Challenges Related to This Course</h3>
        <div class="row row-cols-1 row-cols-md-3 g-4">
            {% for challenge in challenges_related %}
                <div class="col">
                    <div class="card h-100 shadow-sm border-0">
                        {% if challenge.picture %}
                            <img src="{{ challenge.picture.url }}" class="card-img-top" alt="{{ challenge.title }} Image">
                        {% else %}
                            <img src="{% static 'images/default_challenge.png' %}" class="card-img-top" alt="Default Challenge Image">
                        {% endif %}
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">{{ challenge.title }}</h5>
                            <p class="card-text">{{ challenge.description|truncatewords:20 }}</p>
                            <a href="{{ challenge.get_detail_url }}" class="btn btn-primary mt-auto">
                                <i class="fas fa-arrow-right me-1"></i> Explore Challenge
                            </a>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="text-muted text-center">No related challenges available at the moment.</p>
    {% endif %}

    <!-- Back to Courses Button -->
    <div class="mt-4 text-center">
        <a href="{% url 'enrolled_courses' %}" class="btn btn-secondary btn-lg">
            <i class="fas fa-arrow-left me-2"></i> My Courses
        </a>
    </div>
</div>

<!-- Include Font Awesome for Icons -->
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

<!-- Include Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Include Animate.css -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">

<!-- Link to External CSS -->
<link href="{% static 'css/course_detail.css' %}" rel="stylesheet" />
{% endblock %}
